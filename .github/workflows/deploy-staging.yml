name: Deploy Staging

on:
  pull_request:
    types: [labeled]

permissions:
  id-token: write
  pull-requests: write

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    if: github.event.label.name == 'deploy-staging'
    steps:
      - uses: actions/checkout@v4

      - name: Wait for CI workflow if running
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for running CI workflow..."

          RUN_ID=$(gh run list \
            --workflow=ci.yml \
            --branch="${{ github.head_ref }}" \
            --json databaseId,status,headSha \
            --jq '.[] | select(.headSha == "${{ github.event.pull_request.head.sha }}") | select(.status == "in_progress" or .status == "queued") | .databaseId' \
            | head -n 1)

          if [ -n "$RUN_ID" ]; then
            echo "CI workflow run $RUN_ID is in progress. Waiting for it to complete..."
            gh run watch "$RUN_ID" --exit-status
            echo "CI workflow completed successfully"
          fi

  deploy-image-to-gcp:
    name: Deploy Image to GCP
    needs: setup
    uses: ./.github/workflows/deploy-image-to-gcp.yml
    secrets: inherit

  deploy-staging:
    name: Deploy Staging
    needs: deploy-image-to-gcp
    uses: ./.github/workflows/deploy-environment.yml
    secrets: inherit
    with:
      environment: staging
      image: ${{ needs.deploy-image-to-gcp.outputs.image }}
      region: europe-west4
      region_name: netherlands
      services: '["analytics", "worker"]'

  healthchecks:
    name: Healthchecks
    needs: deploy-staging
    if: needs.deploy-staging.outputs.result == 'success'
    uses: ./.github/workflows/run-healthchecks.yml
    secrets: inherit
    with:
      environment: staging
      healthcheck_urls: '[{"name":"staging-subdomain","base_url":"https://traffic-analytics-subdomain.ghost.is/"},{"name":"staging-custom-domain","base_url":"https://traffic-analytics.ghst.pro/"},{"name":"staging-subdirectory","base_url":"https://traffic-analytics-subdirectory.ghost.is/blog/"}]'

  finalize:
    name: Finalize Deployment
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Get tree SHA
        id: tree
        run: echo "sha=$(git rev-parse HEAD^{tree})" >> $GITHUB_OUTPUT

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ needs.deploy-staging.outputs.result }}" == "success" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --body "✅ Deployed to staging (tree: ${{ steps.tree.outputs.sha }})"
          else
            gh pr comment ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --body "❌ Staging deployment failed (tree: ${{ steps.tree.outputs.sha }})"
          fi

      - name: Remove label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --remove-label "deploy-staging"

