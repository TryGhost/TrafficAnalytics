# CI override that extends the base compose.yml
# This removes volumes and bind mounts while using pre-built images

services:
  # Override emulator services to use CI-specific project name
  firestore:
    environment:
      - GOOGLE_CLOUD_PROJECT=traffic-analytics-ci

  pubsub:
    environment:
      - GOOGLE_CLOUD_PROJECT=traffic-analytics-ci
      - PUBSUB_TOPIC_PAGE_HITS_RAW=traffic-analytics-page-hits-raw
      - PUBSUB_SUBSCRIPTION_PAGE_HITS_RAW=traffic-analytics-page-hits-raw-sub

  # Override lint service to use pre-built image
  lint:
    image: ${DOCKER_IMAGE}
    environment:
      - NODE_ENV=testing
    networks:
      - dev-network
    profiles: []

  # Override test service to use pre-built image and CI configuration
  test:
    image: ${DOCKER_IMAGE}
    command: ["yarn", "test"]
    environment:
      - NODE_ENV=testing
      - GOOGLE_CLOUD_PROJECT=traffic-analytics-ci
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - PUBSUB_EMULATOR_HOST=pubsub:8085
      - PUBSUB_TOPIC_PAGE_HITS_RAW=traffic-analytics-page-hits-raw
      - PUBSUB_SUBSCRIPTION_PAGE_HITS_RAW=traffic-analytics-page-hits-raw-sub
      - FIRESTORE_DATABASE_ID=(default)
      - FIRESTORE_SALT_COLLECTION=salts
      - GOOGLE_APPLICATION_CREDENTIALS=/dev/null
    networks:
      - dev-network
    profiles: []
    depends_on:
      firestore:
        condition: service_healthy
      pubsub:
        condition: service_healthy